# 手动测试 - 快速开始

## 🚀 最简单的方式：一键启动

```bash
cd /workspace/lp-staking

# 运行快速测试脚本（自动完成所有准备工作）
./scripts/quick-test.sh

# 然后运行交互式测试
npx ts-node manual-test.ts
```

## 📋 测试步骤

### 步骤 1: 准备环境（如果还没运行快速脚本）

```bash
# 终端 1: 启动验证器
solana-test-validator

# 终端 2: 部署并初始化
cd /workspace/lp-staking
anchor test --skip-local-validator
```

### 步骤 2: 交互式测试（推荐）

```bash
npx ts-node manual-test.ts
```

你会看到一个菜单：
```
测试选项:
1. 质押 LP tokens
2. 解除质押
3. 领取奖励
4. 充值 Reward Vault
5. 查看当前状态 (刷新)
0. 退出
```

**建议的测试流程:**
1. 选择 `4` → 输入 `10` (充值 10 SOL 到 Reward Vault)
2. 选择 `1` → 输入 `5` (质押 5 LP)
3. 等待 30 秒
4. 选择 `5` (刷新查看状态，观察 Pending Reward)
5. 选择 `3` (领取奖励)
6. 选择 `2` → 输入 `all` (解除全部质押)

### 步骤 3: 使用命令行脚本（快速测试单个功能）

```bash
# 质押 5 LP
npx ts-node scripts/test-stake.ts 5

# 等待 20 秒让奖励累积...
sleep 20

# 解除质押 2 LP
npx ts-node scripts/test-unstake.ts 2

# 领取奖励
npx ts-node scripts/test-claim.ts

# 解除全部质押
npx ts-node scripts/test-unstake.ts all
```

## 🔍 验证奖励计算

当前配置: **FixedRate 模式，每秒 0.001 SOL**

**计算公式:**
```
用户每秒奖励 = (用户质押 / 总质押) × 0.001 SOL
```

**示例验证:**
假设你是唯一的质押者，质押了 5 LP:
- 质押 10 秒后预期奖励: 10 × 0.001 = 0.01 SOL
- 质押 30 秒后预期奖励: 30 × 0.001 = 0.03 SOL

**实际验证步骤:**
```bash
# 1. 质押
npx ts-node scripts/test-stake.ts 5
# 记录时间 T1

# 2. 等待 30 秒
sleep 30

# 3. 查看状态（使用交互脚本）
npx ts-node manual-test.ts
# 选择 5 查看状态
# 观察 Pending Reward 应该约为 0.03 SOL
```

## 💡 常用命令

### 查看余额
```bash
# Reward Vault 余额
solana balance 253KaQanuVPGwt44ixarUcFWjeeBKsAeo2dtRHW9CkBt

# 你的 SOL 余额
solana balance

# 你的 LP Token 余额（需要知道 token account 地址）
spl-token accounts
```

### 充值 Reward Vault
```bash
solana transfer 253KaQanuVPGwt44ixarUcFWjeeBKsAeo2dtRHW9CkBt 10
```

### 查看账户数据
```bash
# 查看池子状态
anchor account lp-staking.PoolState 9o1uwsufiCcELp7PjDWqJ1w6fKAGHtp9AJvuysYZbnRy

# 查看奖励配置
anchor account lp-staking.RewardConfig J3Q5uHAvKnoU86Py28CCL4WmDbmDnzBuLVMLBG9uMVn6
```

## 🐛 问题排查

### "池子未初始化"
运行: `anchor test --skip-local-validator`

### "Insufficient LP balance"
先存入 USDC 获取 LP tokens（Phase 2 测试会自动做这个）

### "Insufficient reward vault balance"
运行: `solana transfer 253KaQanuVPGwt44ixarUcFWjeeBKsAeo2dtRHW9CkBt 10`

### "No reward to claim"
等待更长时间让奖励累积，或者检查是否已质押

### 奖励为 0
确保:
1. 已质押 LP tokens
2. Reward Vault 有足够的 SOL
3. 等待至少 10 秒
4. 池子的 total_staked > 0

## 📊 测试完成清单

完成以下测试项目:

- [ ] ✅ 充值 Reward Vault (10 SOL)
- [ ] ✅ 质押 5 LP tokens
- [ ] ✅ 等待 30 秒观察奖励累积
- [ ] ✅ 解除质押 2 LP
- [ ] ✅ 验证 pending_reward 继续累积
- [ ] ✅ 领取奖励到钱包
- [ ] ✅ 验证 pending_reward 清零
- [ ] ✅ 解除全部剩余质押
- [ ] ✅ 验证池子 total_staked 为 0

---

**推荐**: 新手直接使用交互式脚本 `npx ts-node manual-test.ts`，最简单直观！
