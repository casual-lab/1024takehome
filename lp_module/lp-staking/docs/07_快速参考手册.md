# LP Staking 项目快速参考

## 文档信息
- **文档编号**: 07
- **创建日期**: 2025-10-31
- **用途**: 开发过程中的快速查询参考

---

## 1. 项目信息

### 基本信息
```
项目名称:    lp-staking
程序 ID:     21HQd5MFf1hK9skAe7Hctp535318QQLTQEn29kMeYAP8
版本:       0.1.0
Anchor:     0.32.1
Solana:     2.3.13
```

### 目录位置
```bash
项目根目录:   /workspace/lp-staking
程序源码:     /workspace/lp-staking/programs/lp-staking/src
编译输出:     /workspace/lp-staking/target
文档目录:     /workspace/docs
```

---

## 2. 常用命令

### 开发环境
```bash
# 启动测试验证器（新终端）
solana-test-validator --reset

# 查看验证器日志
tail -f /tmp/validator.log

# 检查节点状态
solana ping

# 查看钱包余额
solana balance

# 空投测试 SOL
solana airdrop 10
```

### 项目编译和测试
```bash
# 进入项目目录
cd /workspace/lp-staking

# 编译项目
anchor build

# 运行测试（待实现）
anchor test

# 部署到本地网络
anchor deploy

# 查看程序日志
solana logs
```

### 代码质量检查
```bash
# Rust 格式化
cargo fmt

# Rust lint 检查
cargo clippy

# 运行单元测试
cargo test

# 查看测试覆盖率
cargo test --verbose
```

---

## 3. 账户结构

### 3.1 PoolState（池子状态）

**PDA Seeds**: `["pool_state"]`

**大小**: 193 字节

**字段**:
```rust
pub struct PoolState {
    pub authority: Pubkey,              // 32 字节 - 管理员地址
    pub wrapped_usdc_mint: Pubkey,      // 32 字节 - USDC Mint
    pub lp_token_mint: Pubkey,          // 32 字节 - LP Token Mint
    pub pool_usdc_account: Pubkey,      // 32 字节 - 池子 USDC 账户
    pub total_deposited: u64,           // 8 字节  - 总存入量
    pub total_lp_supply: u64,           // 8 字节  - LP 总供应
    pub total_staked: u64,              // 8 字节  - 总质押量
    pub reward_vault: Pubkey,           // 32 字节 - 奖励金库
    pub bump: u8,                       // 1 字节  - PDA bump
}
```

### 3.2 UserPosition（用户仓位）

**PDA Seeds**: `["user_position", user_pubkey, pool_pubkey]`

**大小**: 129 字节

**字段**:
```rust
pub struct UserPosition {
    pub owner: Pubkey,                  // 32 字节 - 用户地址
    pub pool: Pubkey,                   // 32 字节 - 池子地址
    pub lp_balance: u64,                // 8 字节  - LP Token 余额
    pub staked_amount: u64,             // 8 字节  - 质押数量
    pub reward_debt: u128,              // 16 字节 - 奖励债务
    pub pending_reward: u64,            // 8 字节  - 待领取奖励
    pub last_stake_time: i64,           // 8 字节  - 上次质押时间
    pub last_claim_time: i64,           // 8 字节  - 上次领取时间
    pub bump: u8,                       // 1 字节  - PDA bump
}
```

### 3.3 RewardConfig（奖励配置）

**PDA Seeds**: `["reward_config", pool_state_pubkey]`

**大小**: 106 字节

**字段**:
```rust
pub struct RewardConfig {
    pub pool: Pubkey,                   // 32 字节 - 池子地址
    pub emission_type: EmissionType,    // 1 字节  - 排放类型
    pub emission_rate: u64,             // 8 字节  - 每秒排放量
    pub initial_block_rate: u64,        // 8 字节  - 初始每块排放量
    pub decay_factor: u64,              // 8 字节  - 衰减因子
    pub blocks_per_period: u64,         // 8 字节  - 周期区块数
    pub last_update_slot: u64,          // 8 字节  - 上次更新 slot
    pub acc_reward_per_share: u128,     // 16 字节 - 累计每份奖励
    pub bump: u8,                       // 1 字节  - PDA bump
}
```

---

## 4. 已实现指令

### 4.1 Initialize

**功能**: 初始化流动性池和奖励系统

**参数**:
```rust
pub fn initialize(
    ctx: Context<Initialize>,
    emission_type: EmissionType,     // 排放类型
    emission_rate: u64,               // 每秒排放量（固定模式）
    initial_block_rate: u64,          // 初始每块排放量（动态模式）
    decay_factor: u64,                // 衰减因子（0-10000）
    blocks_per_period: u64,           // 周期区块数
) -> Result<()>
```

**账户**:
- `authority` - 管理员（Signer, Writable）
- `pool_state` - 池子状态（PDA, Init, Writable）
- `wrapped_usdc_mint` - USDC Mint
- `lp_token_mint` - LP Token Mint（Writable）
- `pool_usdc_account` - 池子 USDC 账户（Writable）
- `reward_vault` - 奖励金库（PDA, Writable）
- `reward_config` - 奖励配置（PDA, Init, Writable）
- `token_program` - Token 程序
- `system_program` - System 程序

**调用示例**（TypeScript）:
```typescript
await program.methods
  .initialize(
    { fixedRate: {} },  // emission_type
    new BN(10_000_000_000),  // emission_rate: 10 SOL/秒
    new BN(0),          // initial_block_rate（固定模式不用）
    new BN(10000),      // decay_factor（固定模式不用）
    new BN(1000),       // blocks_per_period（固定模式不用）
  )
  .accounts({
    authority: authority.publicKey,
    poolState,
    wrappedUsdcMint,
    lpTokenMint,
    poolUsdcAccount,
    rewardVault,
    rewardConfig,
    tokenProgram: TOKEN_PROGRAM_ID,
    systemProgram: SystemProgram.programId,
  })
  .rpc();
```

---

## 5. 待实现指令

### 5.1 Deposit（下一个实现）
```rust
pub fn deposit(ctx: Context<Deposit>, amount: u64) -> Result<()>
```

### 5.2 Withdraw
```rust
pub fn withdraw(ctx: Context<Withdraw>, lp_amount: u64) -> Result<()>
```

### 5.3 Stake
```rust
pub fn stake(ctx: Context<Stake>, amount: u64) -> Result<()>
```

### 5.4 Unstake
```rust
pub fn unstake(ctx: Context<Unstake>, amount: u64) -> Result<()>
```

### 5.5 Claim
```rust
pub fn claim(ctx: Context<Claim>) -> Result<()>
```

---

## 6. 常量定义

```rust
// PDA Seeds
pub const POOL_STATE_SEED: &[u8] = b"pool_state";
pub const USER_POSITION_SEED: &[u8] = b"user_position";
pub const REWARD_CONFIG_SEED: &[u8] = b"reward_config";
pub const REWARD_VAULT_SEED: &[u8] = b"reward_vault";

// 最小金额
pub const MIN_DEPOSIT_AMOUNT: u64 = 1_000_000;  // 1 USDC
pub const MIN_STAKE_AMOUNT: u64 = 100_000;      // 0.1 LP

// 基点
pub const BASIS_POINTS: u64 = 10_000;           // 100%

// 精度
pub const PRECISION: u128 = 1_000_000_000_000;  // 1e12
```

---

## 7. 错误代码

```rust
pub enum LpStakingError {
    InvalidAmount,              // 6000: 金额无效
    InsufficientBalance,        // 6001: 余额不足
    InsufficientLpTokens,       // 6002: LP Token 不足
    InsufficientStaked,         // 6003: 质押量不足
    EmptyPool,                  // 6004: 池子为空
    MathOverflow,               // 6005: 数学溢出
    InvalidEmissionType,        // 6006: 排放类型无效
    Unauthorized,               // 6007: 未授权
    InsufficientRewardVault,    // 6008: 奖励金库余额不足
    InvalidDecayFactor,         // 6009: 衰减因子无效
    InvalidBlocksPerPeriod,     // 6010: 周期长度无效
}
```

---

## 8. 奖励计算公式

### 8.1 固定速率模式

**每秒排放固定数量的奖励**

```
total_reward = emission_rate × time_elapsed
user_reward = (user_staked / total_staked) × total_reward
```

**示例**:
```
emission_rate = 10 SOL/秒
total_staked = 1000 LP
user_staked = 500 LP
time_elapsed = 100 秒

total_reward = 10 × 100 = 1000 SOL
user_reward = (500 / 1000) × 1000 = 500 SOL
```

### 8.2 按块动态模式

**每个周期衰减的动态排放**

```
period = current_slot / blocks_per_period
current_rate = initial_rate × (decay_factor / 10000) ^ period
total_reward = current_rate × blocks_elapsed
user_reward = (user_staked / total_staked) × total_reward
```

**示例**:
```
initial_rate = 100 SOL/块
decay_factor = 9900 (99%)
blocks_per_period = 1000

周期 0 (块 0-999):   rate = 100 SOL/块
周期 1 (块 1000-1999): rate = 99 SOL/块
周期 2 (块 2000-2999): rate = 98.01 SOL/块
```

### 8.3 Masterchef 算法

**精确的用户奖励计算**

```
// 更新累计每份奖励
acc_reward_per_share += (new_reward × PRECISION) / total_staked

// 用户待领取奖励
pending = (user_staked × acc_reward_per_share - reward_debt) / PRECISION

// 质押时更新债务
reward_debt = user_staked × acc_reward_per_share
```

---

## 9. 开发工作流

### 日常开发流程
```bash
# 1. 修改代码
vim programs/lp-staking/src/...

# 2. 编译检查
anchor build

# 3. 运行单元测试
cargo test --package lp-staking

# 4. 运行集成测试
anchor test

# 5. 格式化代码
cargo fmt

# 6. Lint 检查
cargo clippy
```

### 添加新指令流程
```bash
# 1. 创建指令文件
vim programs/lp-staking/src/instructions/new_instruction.rs

# 2. 在 mod.rs 中导出
echo "pub mod new_instruction;" >> programs/lp-staking/src/instructions/mod.rs
echo "pub use new_instruction::*;" >> programs/lp-staking/src/instructions/mod.rs

# 3. 在 lib.rs 中添加方法
vim programs/lp-staking/src/lib.rs

# 4. 编译测试
anchor build

# 5. 编写测试
vim tests/lp-staking.ts
```

---

## 10. 测试网络配置

### 本地测试网
```bash
# 启动验证器
solana-test-validator \
  --reset \
  --ledger .anchor/test-ledger \
  --bind-address 0.0.0.0

# 配置 CLI
solana config set --url localhost
```

### Devnet（未来）
```bash
# 切换到 Devnet
solana config set --url devnet

# 空投（Devnet）
solana airdrop 2

# 部署到 Devnet
anchor deploy --provider.cluster devnet
```

---

## 11. 故障排查

### 常见问题

#### 编译错误
```bash
# 清理缓存
anchor clean
cargo clean

# 重新编译
anchor build
```

#### 测试验证器无法启动
```bash
# 检查进程
ps aux | grep solana-test-validator

# 杀死进程
pkill solana-test-validator

# 重新启动
solana-test-validator --reset
```

#### 账户不存在错误
```bash
# 检查账户
solana account <address>

# 空投 SOL
solana airdrop 10
```

#### IDL 未生成
```bash
# 确保启用 idl-build 特性
# 在 Cargo.toml 中:
[features]
idl-build = ["anchor-lang/idl-build", "anchor-spl/idl-build"]

# 重新编译
anchor build
```

---

## 12. 有用的链接

### 官方文档
- [Anchor 文档](https://www.anchor-lang.com/)
- [Solana 文档](https://docs.solana.com/)
- [SPL Token](https://spl.solana.com/token)

### 代码示例
- [Anchor 示例](https://github.com/coral-xyz/anchor/tree/master/examples)
- [Solana 程序库](https://github.com/solana-labs/solana-program-library)

### 工具
- [Solana Explorer](https://explorer.solana.com/)
- [Anchor Playground](https://beta.solpg.io/)

---

## 13. 团队联系

### 开发团队
- 项目负责人: [待定]
- 技术负责人: [待定]

### 支持渠道
- 文档: `/workspace/docs/`
- 问题跟踪: [待设置]

---

**文档版本**: v1.0  
**最后更新**: 2025-10-31  
**维护者**: LP Module Dev Team
