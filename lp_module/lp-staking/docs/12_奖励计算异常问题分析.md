# ğŸ” å¥–åŠ±è®¡ç®—å¼‚å¸¸é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ“Š å½“å‰çŠ¶æ€

### å®é™…æƒ…å†µ
```
âŒ Reward Config: ä¸å­˜åœ¨ (è´¦æˆ·æœªåˆå§‹åŒ–)
âœ… User Position: å­˜åœ¨
   - Staked Amount: 0 LP
   - Pending Reward: 19,380.80 SOL  â† å¼‚å¸¸å€¼!
   - Reward Debt: 0
```

### åº”è¯¥çš„æƒ…å†µ
```
å¦‚æœç”¨æˆ·è´¨æŠ¼äº† 5 LP,ç­‰å¾… 20 ç§’:
- Emission Rate: 0.001 SOL/ç§’
- æ—¶é—´: 20 ç§’
- è´¨æŠ¼é‡: 5 LP

åº”å¾—å¥–åŠ± = 0.001 SOL/ç§’ Ã— 20 ç§’ = 0.02 SOL
```

**å®é™…æ˜¾ç¤º: 19,380 SOL vs åº”è¯¥æ˜¾ç¤º: ~0.02 SOL**

å·®è·: **çº¦ 100ä¸‡å€!** ğŸš¨

---

## ğŸ› é—®é¢˜æ ¹æº

### 1. Reward Config æœªåˆå§‹åŒ–

**ä¸ºä»€ä¹ˆæ²¡æœ‰åˆå§‹åŒ–?**

- Phase 3 å¼€å‘å‰,æ± å­å°±å·²ç»åˆå§‹åŒ–äº†
- å½“æ—¶çš„ `initialize` æŒ‡ä»¤è¿˜æ²¡æœ‰åˆ›å»º `reward_config` çš„é€»è¾‘
- Phase 3 æ·»åŠ äº† reward_config,ä½†æ²¡æœ‰é‡æ–°éƒ¨ç½²å’Œåˆå§‹åŒ–

**è¯æ®:**
```bash
Pool State: 9o1uwsufiCcELp7PjDWqJ1w6fKAGHtp9AJvuysYZbnRy  âœ… å­˜åœ¨
Reward Config: J3Q5uHAvKnoU86Py28CCL4WmDbmDnzBuLVMLBG9uMVn6  âŒ ä¸å­˜åœ¨
```

### 2. ç¨‹åºä»£ç å¦‚ä½•å¤„ç†?

å½“ `reward_config` ä¸å­˜åœ¨æ—¶,è´¨æŠ¼/è§£é™¤è´¨æŠ¼æŒ‡ä»¤ä¼š:

```rust
// stake.rs / unstake.rs / claim.rs ä¸­éƒ½æœ‰:
let reward_config = &ctx.accounts.reward_config;

// å°è¯•è°ƒç”¨ update_pool_reward
reward_calculator::update_pool_reward(
    &mut ctx.accounts.pool_state,
    reward_config,  // â† è¿™é‡Œä¼ å…¥çš„è´¦æˆ·ä¸å­˜åœ¨!
    current_slot
)?;
```

**å…³é”®é—®é¢˜:** Anchor åœ¨è´¦æˆ·ä¸å­˜åœ¨æ—¶ä¼šè¿”å›ä»€ä¹ˆæ•°æ®?

---

## ğŸ”¬ æ·±å…¥åˆ†æ: ä¸ºä»€ä¹ˆæ˜¯ 19,380 SOL?

### å‡è®¾: æœªåˆå§‹åŒ–è´¦æˆ·çš„é»˜è®¤å€¼

å½“ Solana è´¦æˆ·æœªåˆå§‹åŒ–æ—¶:
- è´¦æˆ·æ•°æ®å…¨éƒ¨ä¸º `0x00` (é›¶å­—èŠ‚)
- Anchor å°è¯•ååºåˆ—åŒ–æ—¶ä¼šå¾—åˆ°å…¨é›¶æ•°æ®

```rust
pub struct RewardConfig {
    pub pool: Pubkey,                    // 32 å­—èŠ‚é›¶
    pub emission_type: EmissionType,     // 0 = FixedRate
    pub emission_rate: u64,              // 0
    pub initial_block_rate: u64,         // 0
    pub decay_factor: u64,               // 0
    pub blocks_per_period: u64,          // 0
    pub last_update_slot: u64,           // 0 â† å…³é”®!
    pub acc_reward_per_share: u128,      // 0 â† å…³é”®!
    pub bump: u8,                        // 0
}
```

### å¥–åŠ±è®¡ç®—å…¬å¼

```rust
// reward_calculator.rs ä¸­çš„é€»è¾‘:
pub fn update_pool_reward(
    pool: &mut PoolState,
    config: &mut RewardConfig,
    current_slot: u64,
) -> Result<()> {
    if pool.total_staked == 0 {
        config.last_update_slot = current_slot;
        return Ok(());
    }

    let slot_diff = current_slot - config.last_update_slot;  // â† é—®é¢˜åœ¨è¿™!
    let reward = calculate_slot_reward(config, slot_diff);
    
    config.acc_reward_per_share += (reward * PRECISION) / pool.total_staked;
    config.last_update_slot = current_slot;
    
    Ok(())
}
```

**é—®é¢˜åœºæ™¯:**

1. **ç¬¬ä¸€æ¬¡è´¨æŠ¼æ—¶:**
   ```
   current_slot = 350,000 (å½“å‰åŒºå—é«˜åº¦)
   config.last_update_slot = 0 (æœªåˆå§‹åŒ–)
   
   slot_diff = 350,000 - 0 = 350,000 ä¸ªåŒºå—!
   ```

2. **è®¡ç®—å¥–åŠ±:**
   ```
   å¦‚æœæ˜¯ BlockBased æ¨¡å¼:
   reward = initial_block_rate Ã— slot_diff
   reward = (æŸä¸ªå€¼) Ã— 350,000
   
   å¦‚æœæ˜¯ FixedRate æ¨¡å¼:
   reward = emission_rate Ã— (slot_diff Ã— å¹³å‡å‡ºå—æ—¶é—´)
   ```

3. **ç´¯è®¡åˆ° acc_reward_per_share:**
   ```
   acc_reward_per_share += (å·¨å¤§çš„reward Ã— 1e12) / 5 LP
   ```

4. **ç”¨æˆ·é¢†å–æ—¶:**
   ```rust
   pending_reward = (staked_amount Ã— acc_reward_per_share / PRECISION) - reward_debt
                  = (0 Ã— å·¨å¤§å€¼ / 1e12) - 0
                  = 0  (ä½†æ˜¯å·²ç»ç´¯ç§¯åˆ° pending_reward å­—æ®µä¸­äº†)
   ```

**å®é™…å‘ç”Ÿ:**
```
User Position ä¸­çš„ pending_reward = 19,380,802,125,994 lamports
                                   = 19,380.80 SOL
```

è¿™æ˜¯å› ä¸ºæ¯æ¬¡ unstake/claim æ—¶,ç¨‹åºä¼šç´¯ç§¯å¥–åŠ±:
```rust
// unstake.rs ä¸­:
let pending = calculate_pending_reward(
    user_position.staked_amount,
    config.acc_reward_per_share,
    user_position.reward_debt,
);
user_position.pending_reward += pending;  // â† ç´¯ç§¯äº†å¼‚å¸¸å€¼
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆäº¤æ˜“èƒ½æˆåŠŸä½†å¥–åŠ±å¼‚å¸¸?

### æˆåŠŸçš„éƒ¨åˆ† âœ…
1. **è´¨æŠ¼/è§£é™¤è´¨æŠ¼é€»è¾‘**: LP token çš„è½¬ç§»æ˜¯æ­£ç¡®çš„
2. **è´¦æˆ·æ›´æ–°**: staked_amountã€lp_balance éƒ½æ­£ç¡®æ›´æ–°
3. **äº¤æ˜“ç­¾å**: ç¨‹åºé€»è¾‘æ²¡æœ‰æŠ¥é”™

### å¤±è´¥çš„éƒ¨åˆ† âŒ
1. **å¥–åŠ±è®¡ç®—**: å› ä¸º `last_update_slot = 0`,å¯¼è‡´è®¡ç®—äº†ä»åˆ›ä¸–åŒºå—åˆ°ç°åœ¨çš„æ‰€æœ‰å¥–åŠ±
2. **å¥–åŠ±é¢†å–**: Vault åªæœ‰ 30 SOL,ä½†å¾…é¢†å– 19,380 SOL â†’ `InsufficientRewardVault` é”™è¯¯

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### å¿…é¡»æ‰§è¡Œ: é‡æ–°éƒ¨ç½²å’Œåˆå§‹åŒ–

```bash
# 1. é‡æ–°æ„å»ºç¨‹åº
anchor build

# 2. é‡æ–°éƒ¨ç½² (ä¼šç”Ÿæˆæ–°çš„ program ID)
anchor deploy

# 3. æ›´æ–° Anchor.toml å’Œ lib.rs ä¸­çš„ program ID

# 4. é‡æ–°ç”Ÿæˆç±»å‹å®šä¹‰
anchor build

# 5. è¿è¡Œå®Œæ•´æµ‹è¯• (ä¼šé‡æ–°åˆå§‹åŒ–æ‰€æœ‰è´¦æˆ·)
anchor test
```

### ä¸ºä»€ä¹ˆå¿…é¡»é‡æ–°åˆå§‹åŒ–?

1. **è´¦æˆ·ä¾èµ–å…³ç³»:**
   - `pool_state` å¼•ç”¨ `reward_vault`
   - `reward_config` å¼•ç”¨ `pool_state`
   - `user_position` å¼•ç”¨ `pool_state`

2. **PDA åœ°å€ä¸å˜:**
   - PDA åœ°å€ç”± seeds + program_id å†³å®š
   - å³ä½¿é‡æ–°éƒ¨ç½²,åŒæ ·çš„ seeds ä¼šç”ŸæˆåŒæ ·çš„ PDA
   - ä½†æ—§çš„ PDA è´¦æˆ·æ•°æ®å¯èƒ½ä¸å…¼å®¹

3. **æ•°æ®å®Œæ•´æ€§:**
   - éœ€è¦ç¡®ä¿ `reward_config.last_update_slot` ä»å½“å‰ slot å¼€å§‹
   - éœ€è¦ç¡®ä¿æ‰€æœ‰åˆå§‹å€¼æ­£ç¡®è®¾ç½®

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

è¿è¡Œæµ‹è¯•å‰å¿…é¡»ç¡®è®¤:

- [ ] `anchor test` æˆåŠŸå®Œæˆ
- [ ] Reward Config è´¦æˆ·å­˜åœ¨
- [ ] `config.last_update_slot` = åˆå§‹åŒ–æ—¶çš„ slot (ä¸æ˜¯ 0)
- [ ] `config.emission_rate` = é¢„æœŸå€¼ (å¦‚ 1,000,000 lamports = 0.001 SOL)
- [ ] `config.acc_reward_per_share` = 0 (åˆå§‹å€¼)

---

## ğŸ“ æ€»ç»“

**é—®é¢˜:** å¥–åŠ±æ˜¾ç¤º 19,380 SOL,åº”è¯¥æ˜¾ç¤º ~0.02 SOL

**åŸå› :** 
1. Reward Config è´¦æˆ·æœªåˆå§‹åŒ– (å…¨é›¶æ•°æ®)
2. `last_update_slot = 0` å¯¼è‡´è®¡ç®—äº† 350,000 ä¸ªåŒºå—çš„å¥–åŠ±
3. å¼‚å¸¸å¥–åŠ±ç´¯ç§¯åˆ° `user_position.pending_reward`

**è§£å†³:** 
è¿è¡Œ `anchor test` é‡æ–°éƒ¨ç½²å’Œåˆå§‹åŒ–æ‰€æœ‰è´¦æˆ·

**æ•™è®­:**
- åœ¨æ·»åŠ æ–°çš„è´¦æˆ·ç»“æ„å,å¿…é¡»é‡æ–°åˆå§‹åŒ–
- æœªåˆå§‹åŒ–çš„è´¦æˆ·æ•°æ®æ˜¯é›¶å­—èŠ‚,å¯èƒ½å¯¼è‡´é€»è¾‘é”™è¯¯
- æ—¶é—´/åŒºå—ç›¸å…³è®¡ç®—å¿…é¡»éªŒè¯èµ·å§‹ç‚¹æ­£ç¡®æ€§
