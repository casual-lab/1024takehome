# Ë∂ÖÊó∂ÂõûÊªö‰∏éÊïÖÈöúÊÅ¢Â§çÂçèËÆÆËÆæËÆ°

## 1. ÈóÆÈ¢òÂàÜÊûê

### 1.1 ÂΩìÂâçÊû∂ÊûÑÁöÑÁº∫Èô∑

Âú® `01-Ë∑®ÈìæÊ°•ÊäÄÊúØÊû∂ÊûÑËÆæËÆ°.md` ‰∏≠ÁöÑÊ≠£Â∏∏ÊµÅÁ®ãÂ≠òÂú®‰∏Ä‰∏™ÂÖ≥ÈîÆÈóÆÈ¢òÔºö

```
Solana ÈîÅÂÆö‰ª£Â∏Å ‚Üí Relayer Ëé∑ÂèñËØÅÊòé ‚Üí [Relayer ÂÆïÊú∫] ‚Üí ‚ùå Ê∫êÈìæÊó†ÊÑüÁü•
```

**Ê†∏ÂøÉÁüõÁõæ**Ôºö
- Ê∫êÈìæÔºàSolanaÔºâÂè™Áü•ÈÅìËá™Â∑±ÈîÅÂÆö‰∫Ü‰ª£Â∏Å
- Ê∫êÈìæ**‰∏çÁü•ÈÅì**ÁõÆÊ†áÈìæÔºàEVMÔºâÊòØÂê¶ÊàêÂäüÈì∏ÈÄ†
- Relayer ÂÆïÊú∫ÂêéÔºåÊ∫êÈìæÁº∫‰πèËß¶ÂèëË∂ÖÊó∂ÂõûÊªöÁöÑÊú∫Âà∂

### 1.2 Ê†πÊú¨ÂéüÂõ†

Ë∑®ÈìæÊòØ**ÂºÇÊ≠•ËøáÁ®ã**Ôºå‰∏§Êù°Èìæ‰πãÈó¥Ê≤°ÊúâÁõ¥Êé•ÈÄö‰ø°Ôºö
- Solana ‰∏çËÉΩÁõ¥Êé•Êü•ËØ¢ EVM ÁöÑÁä∂ÊÄÅ
- ÂøÖÈ°ª‰æùËµñ**Êó∂Èó¥Áª¥Â∫¶**‰Ωú‰∏∫ÊïÖÈöúÊ£ÄÊµãÊâãÊÆµ
- ÈúÄË¶ÅÊòéÁ°Æ**Ë∞ÅÊúâÊùÉËß¶ÂèëË∂ÖÊó∂ÂõûÊªö**

---

## 2. Ëß£ÂÜ≥ÊñπÊ°àËÆæËÆ°

### 2.1 Ê†∏ÂøÉÊÄùË∑Ø

ÈááÁî® **"Ë∂ÖÊó∂Âç≥Â§±Ë¥•"** ÂéüÂàôÔºö

1. **Ê∫êÈìæËÆæÁΩÆËÆ¢ÂçïË∂ÖÊó∂Êó∂Èó¥**ÔºöÈîÅÂÆö‰ª£Â∏ÅÊó∂ËÆ∞ÂΩï `created_slot/created_block`
2. **‰ªª‰Ωï‰∫∫ÈÉΩÂèØ‰ª•Ëß¶ÂèëË∂ÖÊó∂Ê£ÄÊü•**ÔºöÁî®Êà∑„ÄÅÂÖ∂‰ªñ relayer„ÄÅÁõëÊéßÊú∫Âô®‰∫∫
3. **Ë∂ÖÊó∂ÂêéËá™Âä®ÂÖÅËÆ∏ÈÄÄÊ¨æ**ÔºöÊó†ÈúÄÈ™åËØÅÁõÆÊ†áÈìæÁä∂ÊÄÅÔºåÊó∂Èó¥Âà∞‰∫ÜÂ∞±ËÉΩÈÄÄ

**ÂÖ≥ÈîÆËÆæËÆ°ÁÇπ**Ôºö
- ‚úÖ Ê∫êÈìæÂè™ÈúÄÊ£ÄÊü•Ôºö`ÂΩìÂâçÊó∂Èó¥ - ÂàõÂª∫Êó∂Èó¥ > Ë∂ÖÊó∂ÈòàÂÄº`
- ‚úÖ ‰∏ç‰æùËµñÁõÆÊ†áÈìæÂèçÈ¶àÔºàÈÅøÂÖçË∑®ÈìæÊü•ËØ¢ÁöÑÂ§çÊùÇÊÄßÔºâ
- ‚úÖ Áâ∫Áâ≤‰∏ÄÂÆöÊó∂Èó¥Êç¢ÂèñÂÆâÂÖ®ÊÄßÔºàÁî®Êà∑ÈúÄÁ≠âÂæÖË∂ÖÊó∂ÊúüÔºâ

### 2.2 Áä∂ÊÄÅÊú∫ËÆæËÆ°

```
ËÆ¢ÂçïÁä∂ÊÄÅËΩ¨Êç¢Âõæ:

   [Áî®Êà∑ÂèëËµ∑]
       ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ Pending ‚îÇ ‚Üê ÂàùÂßãÁä∂ÊÄÅ: ‰ª£Â∏ÅÂ∑≤ÈîÅÂÆöÔºåÁ≠âÂæÖ relayer Â§ÑÁêÜ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì ‚Üì
       ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ                                    ‚îÇ (Êó∂Èó¥Ë∂ÖÊó∂)
       ‚îÇ (Relayer Êèê‰∫§ËØÅÊòé)                 ‚îÇ
       ‚Üì                                    ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ Completed ‚îÇ                      ‚îÇ Refunded ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   (‰ª£Â∏ÅÂ∑≤Èì∏ÈÄ†Âà∞                       (‰ª£Â∏ÅÂ∑≤ÈÄÄËøò
    ÁõÆÊ†áÈìæÔºåËÆ¢Âçï                        ÁªôÁî®Êà∑ÔºåËÆ¢Âçï
    ‰∏çÂèØÈÄÜ)                            ‰∏çÂèØÈÄÜ)
```

**Áä∂ÊÄÅËΩ¨Êç¢ËßÑÂàô**Ôºö
- `Pending ‚Üí Completed`: Relayer Âú®Ë∂ÖÊó∂ÂâçÊèê‰∫§ÊúâÊïà ZK ËØÅÊòé
- `Pending ‚Üí Refunded`: ‰ªª‰Ωï‰∫∫Âú®Ë∂ÖÊó∂ÂêéË∞ÉÁî® `refund_timeout()`
- `Completed/Refunded`: ÁªàÊÄÅÔºå‰∏çÂèØÂÜçËΩ¨Êç¢

**Èò≤Ê≠¢Á´ûÊÄÅÊù°‰ª∂**Ôºö
- Relayer Êèê‰∫§ËØÅÊòéÊó∂ÔºåÂøÖÈ°ªÊ£ÄÊü•Áä∂ÊÄÅÊòØ `Pending`
- Áî®Êà∑Áî≥ËØ∑ÈÄÄÊ¨æÊó∂ÔºåÂøÖÈ°ªÊ£ÄÊü•Áä∂ÊÄÅÊòØ `Pending` ‰∏îÂ∑≤Ë∂ÖÊó∂
- ‰ΩøÁî®ÂéüÂ≠êÊÄßÊìç‰ΩúÔºàCASÔºâÈò≤Ê≠¢Âπ∂Âèë‰øÆÊîπ

---

## 3. ËØ¶ÁªÜÂçèËÆÆÊµÅÁ®ã

### 3.1 Ê≠£Â∏∏ÊµÅÁ®ãÔºàÂê´Ë∂ÖÊó∂‰øùÊä§Ôºâ

```
Êó∂Èó¥ËΩ¥Ôºö0s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 30s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 60s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 90s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Ë∂ÖÊó∂ÈòàÂÄº(600s) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí

Áî®Êà∑ (Solana)           Solana Program          Relayer              EVM Contract
    |                         |                      |                      |
    |--lock_tokens(100)------>|                      |                      |
  [T=0]                       |                      |                      |
    |                    [ÈîÅÂÆö‰ª£Â∏Å]                  |                      |
    |                    [Order #1: Pending]         |                      |
    |                    [created_slot = 1000]       |                      |
    |                    [timeout = 1000 + 1200      |                      |
    |                     = 2200 slot]               |                      |
    |                         |                      |                      |
    |                         |--TokensLocked------->|                      |
  [T=10s]                     |                      |                      |
    |                         |                 [ÁõëÂê¨Âà∞‰∫ã‰ª∂]                |
    |                         |                 [Ëé∑Âèñ Solana Áä∂ÊÄÅ]          |
  [T=30s]                     |                      |                      |
    |                         |                 [SP1 ÁîüÊàêËØÅÊòé]              |
    |                         |                 [ËÄóÊó∂ 20-50s]               |
  [T=60s]                     |                      |                      |
    |                         |                      |--mintTokens(proof)-->|
    |                         |                      |                      |
    |                         |                      |                 [È™åËØÅ proof]
    |                         |                      |                 [Ê£ÄÊü•Áä∂ÊÄÅ=Pending]
    |                         |                      |                 [Èì∏ÈÄ†‰ª£Â∏Å]
    |                         |                      |                      |
    |                         |<---ÁõÆÊ†áÈìæÊàêÂäü‰∫ã‰ª∂(ÈÄöËøá relayer Êèê‰∫§ proof hash)--|
    |                         |                      |                      |
    |                    [Êõ¥Êñ∞ Order #1:             |                      |
    |                     status = Completed]        |                      |
    |                    [ËÆ∞ÂΩï proof_hash]           |                      |
    |                         |                      |                      |
    |                         |                      |<--relayer fee--------|
    |                         |                      |                      |
    
‚úÖ ËÆ¢ÂçïÂú®Ë∂ÖÊó∂ÂâçÂÆåÊàêÔºåÁî®Êà∑Âú® EVM Êî∂Âà∞‰ª£Â∏Å
```

### 3.2 Relayer ÂÆïÊú∫Âú∫ÊôØÔºàÁî®Êà∑‰∏ªÂä®ÈÄÄÊ¨æÔºâ

```
Êó∂Èó¥ËΩ¥Ôºö0s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Ë∂ÖÊó∂ÈòàÂÄº(600s) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí

Áî®Êà∑ (Solana)           Solana Program          Relayer              EVM Contract
    |                         |                      |                      |
    |--lock_tokens(100)------>|                      |                      |
  [T=0]                       |                      |                      |
    |                    [Order #1: Pending]         |                      |
    |                    [created_slot = 1000]       |                      |
    |                         |                      |                      |
    |                         |--TokensLocked------->|                      |
    |                         |                      |                      |
    |                         |                 [üíÄ Relayer ÂÆïÊú∫]          |
  [T=10s]                     |                      X                      |
    |                         |                      |                      |
    |    ... Áî®Êà∑Á≠âÂæÖ 10 ÂàÜÈíü (600s) ...              |                      |
    |                         |                      |                      |
  [T=600s]                    |                      |                      |
    |  (ÂΩìÂâç slot = 2200)     |                      |                      |
    |                         |                      |                      |
    |--refund_timeout(#1)---->|                      |                      |
    |                         |                      |                      |
    |                    [Ê£ÄÊü•Êù°‰ª∂:]                  |                      |
    |                    [1. status == Pending ‚úÖ]   |                      |
    |                    [2. current_slot(2200)      |                      |
    |                        >= created_slot(1000)   |                      |
    |                           + timeout(1200) ‚úÖ]  |                      |
    |                         |                      |                      |
    |                    [Ëß£ÈîÅ‰ª£Â∏ÅÂà∞Áî®Êà∑Ë¥¶Êà∑]         |                      |
    |                    [status = Refunded]         |                      |
    |                         |                      |                      |
    |<-----100 SPL ÈÄÄÊ¨æ-------|                      |                      |
    |                         |                      |                      |

‚úÖ Áî®Êà∑ÊàêÂäüÂèñÂõûËµÑÈáëÔºåËÆ¢ÂçïÊ†áËÆ∞‰∏∫ Refunded

ÂêéÁª≠Â¶ÇÊûú Relayer ÊÅ¢Â§ç:
  [T=700s]                    |                      |                      |
    |                         |                 [ÊÅ¢Â§çËøêË°å]                  |
    |                         |                 [Â∞ùËØïÊèê‰∫§ËØÅÊòé]              |
    |                         |                      |                      |
    |                         |                      |--mintTokens(proof)-->|
    |                         |                      |                      |
    |                         |                      |                 [È™åËØÅ proof]
    |                         |                      |                 [Ê£ÄÊü•Ê∫êÈìæÁä∂ÊÄÅ]
    |                         |                      |                      |
    |                         |<---Êü•ËØ¢ Order #1 Áä∂ÊÄÅ(ÈÄöËøáÈ¢ÑË®ÄÊú∫Êàñ ZK ËØÅÊòé)--|
    |                         |                      |                      |
    |                    [ËøîÂõû: status = Refunded]   |                      |
    |                         |                      |                      |
    |                         |                      |<--‰∫§ÊòìÂõûÊªö-----------| ‚ùå
    |                         |                      |                [ÊãíÁªùÈì∏ÈÄ†:
    |                         |                      |                 ËÆ¢ÂçïÂ∑≤ÈÄÄÊ¨æ]

‚úÖ Èò≤Ê≠¢ÂèåËä±ÔºöÁõÆÊ†áÈìæÊãíÁªù‰∏∫Â∑≤ÈÄÄÊ¨æËÆ¢ÂçïÈì∏ÈÄ†‰ª£Â∏Å
```

### 3.3 Á´û‰∫âÂú∫ÊôØÔºöRelayer ÂíåÁî®Êà∑ÂêåÊó∂Êìç‰Ωú

```
[Relayer Ê≠£Âú®Êèê‰∫§ËØÅÊòé] vs [Áî®Êà∑Â∞ùËØïÈÄÄÊ¨æ]

Âú∫ÊôØ 1: Relayer ÂÖàÊèê‰∫§ÔºàËÆ¢ÂçïÂú®Ë∂ÖÊó∂ÂâçÂÆåÊàêÔºâ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Relayer: mintTokens(proof) ‚Üí [T=590s] ‚Üí EVM È™åËØÅÈÄöËøá ‚Üí Èì∏ÈÄ†‰ª£Â∏Å
                                                      ‚Üì
  Solana: Êé•Êî∂ proof_hash ‚Üí Êõ¥Êñ∞ status = Completed [T=595s]
                                                      ‚Üì
  User: refund_timeout() ‚Üí [T=601s] ‚Üí ‚ùå Â§±Ë¥• (status != Pending)

‚úÖ Relayer Ëé∑ËÉúÔºåÁî®Êà∑Êó†Ê≥ïÈÄÄÊ¨æ


Âú∫ÊôØ 2: Áî®Êà∑ÂÖàÈÄÄÊ¨æÔºàËÆ¢ÂçïË∂ÖÊó∂Ôºâ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  User: refund_timeout() ‚Üí [T=601s] ‚Üí Solana Ê£ÄÊü•Ë∂ÖÊó∂ ‚Üí status = Refunded
                                                      ‚Üì
  Relayer: mintTokens(proof) ‚Üí [T=605s] ‚Üí EVM È™åËØÅÈÄöËøá
                                         ‚Üì
                                    Ê£ÄÊü•Ê∫êÈìæÁä∂ÊÄÅÔºàÈÄöËøá ZK ËØÅÊòéÔºâ
                                         ‚Üì
                                    [Order status = Refunded]
                                         ‚Üì
                                    ‚ùå ÊãíÁªùÈì∏ÈÄ†

‚úÖ Áî®Êà∑Ëé∑ËÉúÔºåRelayer Êó†Ê≥ïÂÆåÊàêÈì∏ÈÄ†


Âú∫ÊôØ 3: Âá†‰πéÂêåÊó∂ÔºàÈúÄË¶ÅÂéüÂ≠êÊÄß‰øùÊä§Ôºâ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Relayer: mintTokens(proof)  ‚Üí [T=600.5s]
  User: refund_timeout()      ‚Üí [T=600.6s]

  ÂÖ≥ÈîÆÔºöSolana Program ‰ΩøÁî®**Ë¥¶Êà∑ÈîÅ + CAS Êìç‰Ωú**
  
  ÊâßË°åÈ°∫Â∫èÔºàÁî± Solana ËøêË°åÊó∂ÂÜ≥ÂÆöÔºâ:
  
  If Relayer ÂÖàÊâßË°å:
    1. Relayer Êõ¥Êñ∞ status = Completed
    2. User ÁöÑ‰∫§ÊòìÊ£ÄÊü• status != Pending ‚Üí ‚ùå Â§±Ë¥•
  
  If User ÂÖàÊâßË°å:
    1. User Êõ¥Êñ∞ status = Refunded
    2. Relayer ÁöÑ‰∫§ÊòìÊ£ÄÊü• status != Pending ‚Üí ‚ùå Â§±Ë¥•
    3. EVM Á´ØÁ®çÂêé‰πü‰ºöÊãíÁªùÈì∏ÈÄ†

‚úÖ ÂéüÂ≠êÊÄß‰øùËØÅÔºöÊúâ‰∏îÂè™Êúâ‰∏ÄÊñπÊàêÂäü
```

---

## 4. ÊäÄÊúØÂÆûÁé∞ÁªÜËäÇ

### 4.1 Solana Program ÂÆûÁé∞

```rust
#[derive(Accounts)]
pub struct RefundTimeout<'info> {
    #[account(
        mut,
        seeds = [b"order", order.order_id.to_le_bytes().as_ref()],
        bump,
        constraint = order.status == OrderStatus::Pending @ BridgeError::OrderNotPending,
    )]
    pub order: Account<'info, TransferOrder>,
    
    #[account(mut)]
    pub user: Signer<'info>,
    
    pub bridge_config: Account<'info, BridgeConfig>,
    
    /// ‰ª£Â∏ÅË¥¶Êà∑ÔºàÈÄÄÊ¨æÁõÆÊ†áÔºâ
    #[account(mut)]
    pub user_token_account: Account<'info, TokenAccount>,
    
    /// Ê°•ÂêàÁ∫¶‰ª£Â∏ÅË¥¶Êà∑ÔºàÈîÅÂÆöÊ∫êÔºâ
    #[account(mut)]
    pub bridge_token_account: Account<'info, TokenAccount>,
    
    pub token_program: Program<'info, Token>,
}

pub fn refund_timeout(ctx: Context<RefundTimeout>) -> Result<()> {
    let order = &mut ctx.accounts.order;
    let clock = Clock::get()?;
    let current_slot = clock.slot;
    
    // 1. Ê£ÄÊü•ÊòØÂê¶Ë∂ÖÊó∂
    require!(
        current_slot >= order.created_slot + ctx.accounts.bridge_config.timeout_slots,
        BridgeError::OrderNotTimedOut
    );
    
    // 2. Ê£ÄÊü•ËÆ¢ÂçïÁä∂ÊÄÅÔºàÈò≤Ê≠¢ÈáçÂ§çÈÄÄÊ¨æÔºâ
    require!(
        order.status == OrderStatus::Pending,
        BridgeError::OrderNotPending
    );
    
    // 3. Ê£ÄÊü•Ë∞ÉÁî®ËÄÖÊùÉÈôêÔºàÂè™ÊúâÂéüÂßãÁî®Êà∑ÂèØ‰ª•ÈÄÄÊ¨æÔºâ
    require!(
        order.user == ctx.accounts.user.key(),
        BridgeError::UnauthorizedUser
    );
    
    // 4. Ëß£ÈîÅ‰ª£Â∏ÅÔºàÂéüÂ≠êÊìç‰ΩúÔºâ
    token::transfer(
        CpiContext::new(
            ctx.accounts.token_program.to_account_info(),
            Transfer {
                from: ctx.accounts.bridge_token_account.to_account_info(),
                to: ctx.accounts.user_token_account.to_account_info(),
                authority: ctx.accounts.bridge_config.to_account_info(),
            },
        ),
        order.amount,
    )?;
    
    // 5. Êõ¥Êñ∞ËÆ¢ÂçïÁä∂ÊÄÅÔºàÈò≤Ê≠¢ÂêéÁª≠Êìç‰ΩúÔºâ
    order.status = OrderStatus::Refunded;
    order.refunded_slot = Some(current_slot);
    
    emit!(OrderRefunded {
        order_id: order.order_id,
        user: order.user,
        amount: order.amount,
        refunded_slot: current_slot,
    });
    
    Ok(())
}
```

### 4.2 EVM Contract ÂÆûÁé∞

```solidity
// EVM Á´ØÈúÄË¶ÅÈ™åËØÅÊ∫êÈìæËÆ¢ÂçïÊú™Ë¢´ÈÄÄÊ¨æ
function mintTokens(
    uint256 orderId,
    bytes calldata zkProof
) external nonReentrant {
    TransferOrder storage order = orders[orderId];
    
    // 1. Âü∫Á°ÄÊ£ÄÊü•
    require(order.user != address(0), "Order not found");
    require(order.status == OrderStatus.Pending, "Order not pending");
    
    // 2. È™åËØÅ ZK ËØÅÊòéÔºàÂåÖÂê´Ê∫êÈìæËÆ¢ÂçïÁä∂ÊÄÅÔºâ
    CrossChainProof memory proof = sp1Verifier.verify(zkProof);
    
    require(proof.orderId == orderId, "Order ID mismatch");
    require(proof.sourceChainStatus == SourceStatus.Locked, "Invalid source status");
    require(proof.isValid, "Invalid proof");
    
    // 3. Ê£ÄÊü•Êó∂Èó¥Á™óÂè£ÔºàÈ¢ùÂ§ñÂÆâÂÖ®Ê£ÄÊü•Ôºâ
    // Á°Æ‰øùËØÅÊòéÊòØÂú®ÂêàÁêÜÊó∂Èó¥ÂÜÖÁîüÊàêÁöÑ
    require(
        block.number <= order.createdBlock + config.timeoutBlocks,
        "Proof submitted after timeout"
    );
    
    // 4. Èì∏ÈÄ†‰ª£Â∏Å
    IERC20Mintable(order.tokenAddress).mint(order.recipient, order.amount);
    
    // 5. Êõ¥Êñ∞Áä∂ÊÄÅ
    order.status = OrderStatus.Completed;
    order.completedBlock = block.number;
    order.proofHash = keccak256(zkProof);
    
    // 6. ÊîØ‰ªò relayer Ë¥πÁî®
    if (order.relayerFee > 0) {
        IERC20(order.tokenAddress).transfer(msg.sender, order.relayerFee);
    }
    
    emit TokensMinted(orderId, order.recipient, order.amount, msg.sender);
}

// Ë∂ÖÊó∂ÈÄÄÊ¨æÔºàEVM ‚Üí Solana ÊñπÂêëÔºâ
function refundTimeout(uint256 orderId) external {
    TransferOrder storage order = orders[orderId];
    
    require(order.status == OrderStatus.Pending, "Order not pending");
    require(order.user == msg.sender, "Not order owner");
    require(
        block.number >= order.createdBlock + config.timeoutBlocks,
        "Not timed out yet"
    );
    
    // Ëß£ÈîÅ/ÈîÄÊØÅ‰ª£Â∏Å
    if (order.isNativeEVM) {
        // Ëß£ÈîÅÂéüÁîü EVM ‰ª£Â∏Å
        IERC20(order.tokenAddress).transfer(order.user, order.amount);
    } else {
        // ÈîÄÊØÅÂ§ñÊù•‰ª£Â∏ÅÔºà‰ΩÜËøô‰ºöÂØºËá¥‰∏çÂØπÁß∞ÔºåÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜÔºâ
        // ÂÆûÈôÖ‰∏äÂ∫îËØ•ÈÄöÁü•Ê∫êÈìæËß£ÈîÅÔºåËøôÈáåÊ†áËÆ∞‰∏∫ÂæÖÂ§ÑÁêÜ
        revert("Cross-chain refund not supported yet");
    }
    
    order.status = OrderStatus.Refunded;
    
    emit OrderRefunded(orderId, order.user, order.amount);
}
```

---

## 5. ZK ËØÅÊòé‰∏≠ÁöÑÁä∂ÊÄÅÈ™åËØÅ

### 5.1 SP1 Program ÈúÄË¶ÅÈ™åËØÅÁöÑÂÜÖÂÆπ

```rust
// SP1 zkVM Program
fn verify_solana_order(order_id: u64, solana_state: SolanaState) -> CrossChainProof {
    // 1. È™åËØÅËÆ¢ÂçïË¥¶Êà∑Â≠òÂú®
    let order_account = solana_state.get_account(order_pda_address);
    require!(order_account.is_some(), "Order not found");
    
    // 2. Ëß£ÊûêËÆ¢ÂçïÊï∞ÊçÆ
    let order: TransferOrder = borsh::deserialize(order_account.data)?;
    
    // 3. È™åËØÅËÆ¢ÂçïÁä∂ÊÄÅ
    require!(order.order_id == order_id, "Order ID mismatch");
    require!(order.status == OrderStatus::Pending, "Order not pending"); // üîë ÂÖ≥ÈîÆÊ£ÄÊü•
    
    // 4. È™åËØÅ‰ª£Â∏ÅÂ∑≤ÈîÅÂÆö
    let bridge_token_account = solana_state.get_token_account(bridge_vault);
    require!(bridge_token_account.amount >= order.amount, "Insufficient locked");
    
    // 5. È™åËØÅ Merkle ProofÔºàË¥¶Êà∑Áä∂ÊÄÅÂ±û‰∫éÊüê‰∏™ slot ÁöÑÁä∂ÊÄÅÊ†ëÔºâ
    verify_merkle_proof(
        order_account.hash(),
        solana_state.state_root,
        order_account.merkle_proof,
    )?;
    
    // 6. ËæìÂá∫ËØÅÊòé
    CrossChainProof {
        order_id,
        source_chain_status: SourceStatus::Locked, // ÊòéÁ°ÆÊ†áËÆ∞Ê∫êÈìæÁä∂ÊÄÅ
        amount: order.amount,
        recipient: order.recipient,
        is_valid: true,
        proof_timestamp: solana_state.slot,
    }
}
```

### 5.2 ÁõÆÊ†áÈìæÈ™åËØÅÈÄªËæë

EVM ÂêàÁ∫¶Âú®Ë∞ÉÁî® `sp1Verifier.verify()` Êó∂‰ºöÊ£ÄÊü•Ôºö

1. **ËØÅÊòéÊúâÊïàÊÄß**ÔºöZK ËØÅÊòéÂú®Êï∞Â≠¶‰∏äÊ≠£Á°Æ
2. **Ê∫êÈìæÁä∂ÊÄÅ**ÔºöËÆ¢ÂçïÁä∂ÊÄÅ‰∏∫ `Pending`ÔºàÊú™ÈÄÄÊ¨æÔºâ
3. **Êó∂Èó¥Á™óÂè£**ÔºöËØÅÊòéÁîüÊàêÊó∂Èó¥Âú®Ë∂ÖÊó∂Ââç
4. **ËÆ¢ÂçïÂåπÈÖç**Ôºöorder_id„ÄÅÈáëÈ¢ù„ÄÅÊé•Êî∂ËÄÖ‰∏ÄËá¥

**Èò≤Âæ°Á≠ñÁï•**Ôºö
- Â¶ÇÊûú Relayer Âú®ËÆ¢ÂçïÈÄÄÊ¨æÂêéÊâçÊèê‰∫§ËØÅÊòéÔºåZK ËØÅÊòé‰ºöÊòæÁ§∫ `status = Refunded`
- EVM ÂêàÁ∫¶ÊãíÁªù‰∏∫Èùû `Pending` Áä∂ÊÄÅÁöÑËÆ¢ÂçïÈì∏ÈÄ†‰ª£Â∏Å

---

## 6. ÁõëÊéß‰∏éËá™Âä®Âåñ

### 6.1 Ë∂ÖÊó∂ÁõëÊéßÊú∫Âô®‰∫∫

Èô§‰∫ÜÁî®Êà∑ÊâãÂä®ÈÄÄÊ¨æÔºåÂèØ‰ª•ÈÉ®ÁΩ≤ÁõëÊéßÊú∫Âô®‰∫∫Ëá™Âä®Â∏ÆÂä©Áî®Êà∑Ôºö

```rust
// ÁõëÊéßÊú∫Âô®‰∫∫ÈÄªËæë
async fn monitor_pending_orders() {
    loop {
        // 1. Êâ´ÊèèÊâÄÊúâ Pending ËÆ¢Âçï
        let pending_orders = fetch_pending_orders().await;
        
        for order in pending_orders {
            let current_slot = get_current_slot().await;
            
            // 2. Ê£ÄÊü•ÊòØÂê¶Ë∂ÖÊó∂
            if current_slot >= order.created_slot + TIMEOUT_SLOTS {
                // 3. ‰ª£ÊõøÁî®Êà∑ÂèëËµ∑ÈÄÄÊ¨æ‰∫§ÊòìÔºàÈúÄÁî®Êà∑ÊèêÂâçÊéàÊùÉÔºâ
                // ÊàñËÄÖÂèëÈÄÅÈÄöÁü•ÁªôÁî®Êà∑
                notify_user_for_refund(order.user, order.order_id).await;
                
                // Â¶ÇÊûúÁî®Êà∑ËÆæÁΩÆ‰∫ÜËá™Âä®ÈÄÄÊ¨æÊéàÊùÉ
                if user_has_auto_refund_enabled(order.user) {
                    submit_refund_tx(order.order_id).await;
                }
            }
        }
        
        sleep(Duration::from_secs(60)).await;
    }
}
```

### 6.2 Relayer ÂÅ•Â∫∑Ê£ÄÊü•

```rust
// Relayer ÊúçÂä°ÂÜÖÈÉ®ÁõëÊéß
async fn health_check() {
    loop {
        // 1. Ê£ÄÊü•ÂæÖÂ§ÑÁêÜËÆ¢ÂçïÈòüÂàó
        let pending = get_pending_orders_in_queue().await;
        
        for order in pending {
            let elapsed = now() - order.created_time;
            
            // 2. Â¶ÇÊûúÂ§ÑÁêÜÊó∂Èó¥ËøáÈïøÔºåÂëäË≠¶
            if elapsed > PROOF_GENERATION_MAX_TIME {
                alert("Proof generation timeout", order.order_id);
                
                // 3. Â∞ùËØïÈáçÊñ∞ÁîüÊàêËØÅÊòé
                retry_proof_generation(order.order_id).await;
            }
        }
        
        sleep(Duration::from_secs(30)).await;
    }
}
```

---

## 7. ÊîπËøõÂª∫ËÆÆ

### 7.1 ÂèåÂêëÁ°ÆËÆ§Êú∫Âà∂ÔºàÂèØÈÄâ‰ºòÂåñÔºâ

‰∏∫‰∫ÜÊõ¥Âø´ÂèëÁé∞ Relayer ÊïÖÈöúÔºåÂèØ‰ª•ÂºïÂÖ•**ÂøÉË∑≥Êú∫Âà∂**Ôºö

```
1. Relayer ËÆ§È¢ÜËÆ¢ÂçïÊó∂ÔºåÂú®Ê∫êÈìæÊèê‰∫§ "claim" ‰∫§Êòì
2. Ê∫êÈìæËÆ∞ÂΩï relayer Âú∞ÂùÄÂíåËÆ§È¢ÜÊó∂Èó¥
3. Â¶ÇÊûú relayer Âú®Áü≠Êó∂Èó¥ÂÜÖÔºàÂ¶Ç 2 ÂàÜÈíüÔºâÊú™Êèê‰∫§ËØÅÊòéÔºåÂÖÅËÆ∏ÂÖ∂‰ªñ relayer Êé•Êâã
4. ÊúÄÁªàË∂ÖÊó∂Êó∂Èó¥‰ªç‰∏∫ 10 ÂàÜÈíüÔºå‰Ωú‰∏∫ÊúÄÂêé‰øùÈöú
```

**‰ºòÁÇπ**ÔºöÂä†Âø´ÊïÖÈöúÂèëÁé∞  
**Áº∫ÁÇπ**ÔºöÂ¢ûÂä†Èìæ‰∏ä‰∫§‰∫íÊ¨°Êï∞ÂíåÂ§çÊùÇÂ∫¶

### 7.2 ÂàÜÊÆµË∂ÖÊó∂

```
‚îú‚îÄ‚îÄ Áü≠Ë∂ÖÊó∂Ôºà2 ÂàÜÈíüÔºâÔºöÂÖÅËÆ∏ÂÖ∂‰ªñ relayer Á´û‰∫â
‚îî‚îÄ‚îÄ ÈïøË∂ÖÊó∂Ôºà10 ÂàÜÈíüÔºâÔºöÂÖÅËÆ∏Áî®Êà∑ÈÄÄÊ¨æ
```

### 7.3 ÈÉ®ÂàÜÈÄÄÊ¨æÊú∫Âà∂ÔºàÈ´òÁ∫ßÔºâ

ÂØπ‰∫éÂ§ßÈ¢ùËÆ¢ÂçïÔºåÂèØ‰ª•ËÆæËÆ°Ôºö
- Á¨¨‰∏ÄÈò∂ÊÆµË∂ÖÊó∂ÔºöÈÄÄÊ¨æ 50%
- Á¨¨‰∫åÈò∂ÊÆµË∂ÖÊó∂ÔºöÈÄÄÊ¨æÂâ©‰Ωô 50%
- Relayer Âú®‰ªªÊÑèÈò∂ÊÆµÂÆåÊàêÂèØËé∑ÂæóÂâ©‰ΩôÈáëÈ¢ù

---

## 8. ÊÄªÁªì

### 8.1 Ê†∏ÂøÉÂéüÂàô

| ÂéüÂàô | ÂÆûÁé∞ |
|------|------|
| **Ë∂ÖÊó∂Âç≥Â§±Ë¥•** | Ê∫êÈìæÂè™ÈúÄÊ£ÄÊü•Êó∂Èó¥ÔºåÊó†ÈúÄÊü•ËØ¢ÁõÆÊ†áÈìæ |
| **Áä∂ÊÄÅ‰∏çÂèØÈÄÜ** | Completed/Refunded ÁªàÊÄÅÔºåÈò≤Ê≠¢ÂèåËä± |
| **ÂéüÂ≠êÊÄß‰øùÊä§** | ‰ΩøÁî®Ë¥¶Êà∑ÈîÅÁ°Æ‰øùÁä∂ÊÄÅËΩ¨Êç¢‰∫íÊñ• |
| **‰ªª‰Ωï‰∫∫ÂèØËß¶Âèë** | Áî®Êà∑„ÄÅÁõëÊéßÊú∫Âô®‰∫∫„ÄÅÂ§áÁî® relayer ÈÉΩËÉΩÈÄÄÊ¨æ |
| **ZK ËØÅÊòéÈ™åËØÅÁä∂ÊÄÅ** | ÁõÆÊ†áÈìæÈ™åËØÅÊ∫êÈìæËÆ¢ÂçïÊú™ÈÄÄÊ¨æ |

### 8.2 ÂÆâÂÖ®‰øùËØÅ

1. ‚úÖ **Èò≤Ê≠¢ËµÑÈáëÈîÅÂÆö**ÔºöÁî®Êà∑ÂèØÂú®Ë∂ÖÊó∂ÂêéÂèñÂõûËµÑÈáë
2. ‚úÖ **Èò≤Ê≠¢ÂèåËä±**ÔºöÁä∂ÊÄÅÊú∫‰øùËØÅÊúâ‰∏îÂè™Êúâ‰∏ÄÊñπÊàêÂäü
3. ‚úÖ **Èò≤Ê≠¢ÈáçÊîæ**ÔºöËÆ¢ÂçïÁä∂ÊÄÅ‰∏ÄÊ¨°ÊÄßËΩ¨Êç¢
4. ‚úÖ **Èò≤Ê≠¢ÊÅ∂ÊÑè Relayer**ÔºöËØÅÊòéÂøÖÈ°ªÂåÖÂê´ËÆ¢ÂçïÁä∂ÊÄÅÈ™åËØÅ

### 8.3 Áî®Êà∑‰ΩìÈ™å

- **Ê≠£Â∏∏ÊÉÖÂÜµ**Ôºö1-3 ÂàÜÈíüÂÆåÊàêË∑®Èìæ
- **Relayer ÂÆïÊú∫**Ôºö10 ÂàÜÈíüÂêéÂèØÈÄÄÊ¨æÔºàÂèØÈÄöËøáÁõëÊéßÁº©Áü≠Ôºâ
- **Gas ÊàêÊú¨**ÔºöÁî®Êà∑Âè™ÈúÄÊîØ‰ªòÈÄÄÊ¨æ‰∫§Êòì gas

---

**ÊñáÊ°£ÁâàÊú¨**: v1.0  
**ÊúÄÂêéÊõ¥Êñ∞**: 2025-10-31  
**Áõ∏ÂÖ≥ÊñáÊ°£**: `01-Ë∑®ÈìæÊ°•ÊäÄÊúØÊû∂ÊûÑËÆæËÆ°.md`
