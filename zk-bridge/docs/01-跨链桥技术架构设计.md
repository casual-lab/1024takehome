# Solana-EVM 双向跨链桥技术架构设计

## 1. 系统概述

基于 SP1 zkVM 的 Solana-EVM 双向跨链桥，实现 SPL Token 与 ERC-20 Token 的安全双向转移，具备原子性保证和超时回滚机制。

### 核心特性
- **双向对称**：Solana ↔ Arbitrum/EVM 链双向转移
- **ZK 信任机制**：使用 SP1 zkVM 生成跨链状态证明
- **超时回滚**：故障时自动退款（EVM: block height, Solana: slot）
- **Relayer 激励**：基于手续费的经济模型

---

## 2. 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                    │
│              (发起跨链转账、领取代币、回滚超时订单)                │
└─────────────────────────────────────────────────────────────────┘
                              ↓↑
┌─────────────────────────────────────────────────────────────────┐
│                      智能合约层                                   │
│  ┌──────────────────┐              ┌──────────────────┐         │
│  │  Solana Program  │              │  EVM Contract    │         │
│  │  - Lock/Burn     │              │  - Lock/Burn     │         │
│  │  - Mint/Unlock   │              │  - Mint/Unlock   │         │
│  │  - Verify ZK     │              │  - Verify ZK     │         │
│  │  - Timeout Logic │              │  - Timeout Logic │         │
│  └──────────────────┘              └──────────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              ↓↑
┌─────────────────────────────────────────────────────────────────┐
│                      Relayer 服务层                               │
│  - 监听源链锁定/销毁事件                                           │
│  - 调用 SP1 zkVM 生成证明                                         │
│  - 提交证明到目标链完成铸造                                        │
│  - 监控超时订单并触发回滚                                          │
│  - 赚取手续费收益                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓↑
┌─────────────────────────────────────────────────────────────────┐
│                      SP1 zkVM 层                                 │
│  - 验证源链状态（交易、账户余额、事件日志）                         │
│  - 生成简洁 ZK 证明（Groth16/PLONK）                              │
│  - 目标链高效验证（Gas 优化）                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓↑
┌─────────────────────────────────────────────────────────────────┐
│                      数据层                                       │
│  - Solana RPC: 获取 slot、账户状态、交易证明                       │
│  - EVM RPC: 获取 block、event logs、storage proofs               │
│  - IPFS/Arweave: 存储大型证明数据（可选）                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心组件设计

### 3.1 智能合约层

#### Solana Program
```
程序账户结构:
├── BridgeConfig (PDA)
│   ├── admin: Pubkey
│   ├── evm_chain_id: u64
│   ├── timeout_slots: u64
│   ├── relayer_fee_bps: u16 (基点, 1/10000)
│   ├── sp1_verifier: Pubkey
│   └── paused: bool
│
├── TokenConfig (PDA per token pair)
│   ├── solana_mint: Pubkey
│   ├── evm_token: [u8; 20]
│   ├── is_native_solana: bool
│   └── total_locked: u64
│
└── TransferOrder (PDA per order)
    ├── order_id: u64
    ├── user: Pubkey
    ├── source_chain: u8
    ├── token_config: Pubkey
    ├── amount: u64
    ├── recipient: [u8; 20] or Pubkey
    ├── relayer_fee: u64
    ├── created_slot: u64
    ├── status: enum { Pending, Completed, Refunded }
    └── proof_hash: [u8; 32]

指令:
1. initialize_bridge()
2. register_token_pair()
3. lock_tokens(amount, recipient_evm)  // 原生 Solana token
4. burn_tokens(amount, recipient_evm)  // 外来 token
5. mint_tokens(order_id, proof)        // 使用 ZK 证明铸造
6. unlock_tokens(order_id, proof)      // 使用 ZK 证明解锁
7. refund_timeout(order_id)            // 超时退款
8. claim_relayer_fee(order_id)
```

#### EVM Contract
```solidity
Contract: SolanaEVMBridge

结构体:
- BridgeConfig: 
  - admin, solanaChainId, timeoutBlocks, relayerFeeBps, 
    sp1Verifier, paused

- TokenPair:
  - evmToken, solanaMint, isNativeEVM, totalLocked

- TransferOrder:
  - orderId, user, sourceChain, tokenPair, amount, 
    recipient, relayerFee, createdBlock, status, proofHash

函数:
- initializeBridge()
- registerTokenPair()
- lockTokens(amount, recipientSolana)
- burnTokens(amount, recipientSolana)
- mintTokens(orderId, proof)
- unlockTokens(orderId, proof)
- refundTimeout(orderId)
- claimRelayerFee(orderId)

事件:
- TokensLocked, TokensBurned, TokensMinted, 
  TokensUnlocked, OrderRefunded, RelayerFeeClaimed
```

### 3.2 SP1 zkVM 证明系统

#### 证明内容
```rust
// 源链状态证明
pub struct CrossChainProof {
    // 源链信息
    source_chain_id: u64,
    source_block_height: u64,  // EVM block or Solana slot
    source_state_root: [u8; 32],
    
    // 订单信息
    order_id: u64,
    token_address: [u8; 32],
    amount: u64,
    recipient: [u8; 32],
    action: Action,  // Lock, Burn, Unlock, Mint
    
    // 加密学证据
    event_proof: MerkleProof,  // EVM: event log proof
    account_proof: AccountProof,  // Solana: account state proof
    
    // 验证结果
    is_valid: bool,
}

// SP1 Program 逻辑
fn main() {
    // 1. 从 stdin 读取源链数据
    let chain_data = sp1_zkvm::io::read::<ChainData>();
    
    // 2. 验证交易真实性
    verify_transaction(&chain_data);
    
    // 3. 验证状态转换
    verify_state_transition(&chain_data);
    
    // 4. 验证默克尔证明
    verify_merkle_proof(&chain_data);
    
    // 5. 输出证明结果
    sp1_zkvm::io::commit(&CrossChainProof { ... });
}
```

#### 证明验证流程
1. **Solana → EVM**
   - SP1 Program 验证 Solana transaction 和 account state
   - 生成 Groth16 proof
   - EVM 合约调用 SP1 Verifier 验证 proof
   - 验证通过后铸造/解锁 ERC-20

2. **EVM → Solana**
   - SP1 Program 验证 EVM event logs 和 storage proofs
   - 生成 proof
   - Solana Program 调用 SP1 Verifier 验证
   - 验证通过后铸造/解锁 SPL Token

### 3.3 Relayer 服务

#### 架构设计
```
Relayer Node:
├── Event Monitor
│   ├── Solana Event Listener (WebSocket)
│   └── EVM Event Listener (WebSocket/HTTP)
│
├── Proof Generator
│   ├── SP1 zkVM Runtime
│   ├── Proof Cache (Redis)
│   └── Proof Queue (RabbitMQ)
│
├── Transaction Submitter
│   ├── Solana Transaction Builder
│   ├── EVM Transaction Builder
│   └── Nonce Manager
│
├── Timeout Monitor
│   ├── 扫描 pending orders
│   └── 触发超时退款
│
└── Fee Manager
    ├── 计算最优 gas price
    └── 领取 relayer 奖励
```

#### 工作流程
```
1. 监听源链锁定/销毁事件
   ↓
2. 提取订单参数 (order_id, amount, recipient...)
   ↓
3. 获取源链状态数据 (block/slot, merkle proof, account state)
   ↓
4. 调用 SP1 zkVM 生成证明 (耗时 ~10-60s)
   ↓
5. 提交证明到目标链合约
   ↓
6. 等待交易确认
   ↓
7. 领取 relayer fee
```

---

## 4. 跨链协议流程

### 4.1 正常流程: Solana → EVM

```
用户 (Solana)                Solana Program              Relayer                EVM Contract              用户 (EVM)
    |                              |                        |                         |                        |
    |--lock_tokens(100, 0xABC)---->|                        |                         |                        |
    |                              |                        |                         |                        |
    |                          [锁定 100 SPL]               |                         |                        |
    |                          [创建 Order #1]              |                         |                        |
    |                          [记录 slot N]                |                         |                        |
    |                              |                        |                         |                        |
    |                              |----TokensLocked事件--->|                         |                        |
    |                              |                        |                         |                        |
    |                              |                   [获取 Solana                   |                        |
    |                              |                    状态证明]                      |                        |
    |                              |                        |                         |                        |
    |                              |                   [SP1 zkVM                      |                        |
    |                              |                    生成 proof]                   |                        |
    |                              |                        |                         |                        |
    |                              |                        |----mintTokens(#1, proof)-->                      |
    |                              |                        |                         |                        |
    |                              |                        |                    [验证 proof]                  |
    |                              |                        |                    [铸造 100 ERC-20]             |
    |                              |                        |                    [转给 0xABC]                  |
    |                              |                        |                    [支付 relayer fee]            |
    |                              |                        |                         |                        |
    |                              |                        |                         |------100 tokens------->|
    |                              |                        |<---relayer fee---------|                        |
    |                              |                        |                         |                        |
```

### 4.2 超时回滚流程

```
用户 (Solana)                Solana Program              Relayer                EVM Contract
    |                              |                        |                         |
    |--lock_tokens(100, 0xABC)---->|                        |                         |
    |                              |                        |                         |
    |                          [锁定 100 SPL]               |                         |
    |                          [Order #1]                   |                         |
    |                          [created_slot = N]           |                         |
    |                              |                        |                         |
    |                              |                   [Relayer 故障]                 |
    |                              |                   [未提交证明]                    |
    |                              |                        |                         |
    |          ... 等待超时 (例如 1000 slots) ...           |                         |
    |                              |                        |                         |
    |--refund_timeout(#1)--------->|                        |                         |
    |                              |                        |                         |
    |                       [检查: current_slot             |                         |
    |                        > N + timeout_slots]           |                         |
    |                       [检查: status = Pending]        |                         |
    |                       [解锁 100 SPL]                  |                         |
    |                       [退还给用户]                     |                         |
    |                       [status = Refunded]             |                         |
    |                              |                        |                         |
    |<--------100 SPL 退款---------|                        |                         |
    |                              |                        |                         |
```

### 4.3 双向对称性

| 操作 | Solana → EVM | EVM → Solana |
|------|--------------|--------------|
| 原生代币跨链 | Lock SPL → Mint ERC-20 | Lock ERC-20 → Mint SPL |
| 外来代币返回 | Burn ERC-20 → Unlock SPL | Burn SPL → Unlock ERC-20 |
| 超时判断 | current_slot - created_slot > timeout | block.number - createdBlock > timeout |
| 证明生成 | SP1 验证 Solana state | SP1 验证 EVM logs/storage |
| 证明验证 | EVM 合约验证 | Solana Program 验证 |

---

## 5. 技术选型

### 5.1 开发框架

| 组件 | 技术选型 | 理由 |
|------|----------|------|
| Solana Program | Anchor Framework | 类型安全、自动生成 IDL、简化 PDA 管理 |
| EVM Contract | Solidity 0.8.x + Hardhat | 成熟工具链、丰富测试框架 |
| ZK 证明系统 | SP1 zkVM (Succinct Labs) | 通用 zkVM、支持 Rust、Groth16/PLONK |
| Relayer 后端 | Rust + Tokio | 高性能异步、与 SP1 无缝集成 |
| 数据库 | PostgreSQL + Redis | 持久化订单 + 缓存证明 |
| 消息队列 | RabbitMQ | 解耦事件监听与证明生成 |

### 5.2 测试环境

| 链 | 本地测试工具 | RPC |
|----|--------------|-----|
| Solana | `solana-test-validator` | http://localhost:8899 |
| EVM | Hardhat Network | http://localhost:8545 |
| Arbitrum 测试网 | Arbitrum Sepolia | 公共 RPC |

### 5.3 SP1 zkVM 集成

```rust
// SP1 Prover (Relayer 端)
use sp1_sdk::{ProverClient, SP1Stdin};

let client = ProverClient::new();
let mut stdin = SP1Stdin::new();
stdin.write(&chain_data);

let proof = client.prove(&PROGRAM_ELF, stdin).run()?;

// SP1 Verifier (链上合约)
// Solana: 部署 SP1 Verifier Program
// EVM: 部署 SP1 Verifier Contract (Groth16Verifier.sol)
```

---

## 6. 经济模型

### 6.1 手续费结构

```
用户支付 = 跨链金额 × relayerFeeBps / 10000 + 固定费用

例如:
- 跨链 1000 USDC
- relayerFeeBps = 30 (0.3%)
- 固定费用 = 0.5 USDC
- 总费用 = 1000 × 0.003 + 0.5 = 3.5 USDC
```

### 6.2 Relayer 激励机制

1. **基础奖励**: 每笔订单的 relayer_fee
2. **Gas 补偿**: 动态调整 fee 覆盖链上 gas 成本
3. **质押惩罚** (可选): Relayer 需质押保证金,提交错误证明将被罚没
4. **竞争模式**: 多个 relayer 竞争，最快提交者获得奖励

### 6.3 安全储备金

- 合约持有 5% 跨链金额作为安全储备
- 用于应对极端情况 (如 ZK proof 漏洞)
- 治理投票可调整比例

---

## 7. 安全机制

### 7.1 多层验证

1. **ZK 证明验证**: 核心信任来源
2. **订单状态机**: 防止重放攻击
3. **超时保护**: 防止资金永久锁定
4. **暂停开关**: 紧急情况下冻结合约

### 7.2 攻击防御

| 攻击类型 | 防御措施 |
|---------|---------|
| 重放攻击 | 唯一 order_id + 已完成订单标记 |
| 双花攻击 | ZK 证明验证 + 链上状态检查 |
| DOS 攻击 | Relayer 费用门槛 + Rate limiting |
| 恶意 Relayer | 证明验证 + 竞争机制 |
| 智能合约漏洞 | 审计 + Bug Bounty + 时间锁升级 |

### 7.3 故障恢复

- **Relayer 故障**: 用户可在超时后自行退款
- **ZK 证明生成失败**: Relayer 自动重试或其他 relayer 接手
- **目标链拥堵**: 动态调整 gas price,确保交易上链
- **源链重组**: 等待足够确认数 (Solana: 32 slots, EVM: 12 blocks)

---

## 8. 性能指标

### 8.1 预期性能

- **证明生成时间**: 10-60 秒 (取决于 SP1 zkVM 优化)
- **跨链总时延**: 1-3 分钟
- **Gas 成本**:
  - EVM 验证 proof: ~200k-500k gas
  - Solana 验证 proof: ~50k-100k compute units
- **吞吐量**: 10-50 TPS (受 relayer 并发能力限制)

### 8.2 优化方向

1. **批量证明**: 将多笔订单聚合为一个 ZK proof
2. **递归证明**: 使用 SP1 递归能力压缩证明大小
3. **链下数据**: 将大型 merkle proof 存储在 IPFS
4. **并行 relayer**: 运行多个 relayer 节点提高吞吐

---

## 9. 开发路线图

### Phase 1: 核心协议 (4-6 周)
- [ ] Solana Program 基础框架 (Anchor)
- [ ] EVM Contract 基础框架 (Hardhat)
- [ ] SP1 zkVM 程序开发
- [ ] 本地测试环境搭建

### Phase 2: Relayer 服务 (3-4 周)
- [ ] 事件监听模块
- [ ] SP1 证明生成集成
- [ ] 交易提交逻辑
- [ ] 超时监控

### Phase 3: 集成测试 (2-3 周)
- [ ] 端到端跨链测试
- [ ] 超时回滚测试
- [ ] 并发压力测试
- [ ] 安全审计准备

### Phase 4: 测试网部署 (2 周)
- [ ] Solana Devnet 部署
- [ ] Arbitrum Sepolia 部署
- [ ] 公开测试与 Bug 修复

### Phase 5: 主网准备 (3-4 周)
- [ ] 第三方安全审计
- [ ] Bug Bounty 计划
- [ ] 文档与 SDK
- [ ] 主网部署

---

## 10. 风险评估

| 风险项 | 影响 | 概率 | 缓解措施 |
|--------|------|------|---------|
| SP1 zkVM 不稳定 | 高 | 中 | 深度测试 + 备用方案 (轻客户端) |
| Gas 成本过高 | 中 | 中 | 批量证明 + 递归压缩 |
| Relayer 中心化 | 中 | 高 | 开放 relayer + 经济激励 |
| 智能合约漏洞 | 高 | 低 | 多轮审计 + 形式化验证 |
| 跨链时延过长 | 低 | 中 | 优化 SP1 + 并行处理 |

---

## 11. 下一步行动

1. **评审本文档**: 确认架构方向与技术选型
2. **细化协议**: 详细设计状态机、数据结构、接口定义
3. **POC 开发**: 实现最小可行原型验证核心假设
4. **性能基准**: 测试 SP1 zkVM 在实际数据下的性能

---

**文档版本**: v1.0  
**最后更新**: 2025-10-31  
**作者**: GitHub Copilot
